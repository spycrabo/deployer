# Deployer

Инструмент для автоматизации процесса развертывания проектов на серверах.

Проект состоит из двух исполняемых файлов:

- **api** - HTTP-сервер, принимающий вебхуки и отправляющий задачи в очередь
- **runner** - исполнитель задач из очереди

## Описание конфигурационного файла

Конфигурационный файл должен быть в формате YAML, может храниться в любой директории и иметь любое имя.
Конфиг передается в оба исполняемых файла через флаг `-c`.

Ниже представлено описание всех возможных опций конфига.

##### server

Информация для HTTP-сервера.

##### server.port

Порт, на котором будет запущен HTTP-сервер.

##### webhooks

Список вебхуков, которые будет обрабатывать HTTP-сервер.

##### webhooks.[name]

Имя вебхука. Должно быть уникальным.

##### webhooks.[name].path

Путь, по которому будет доступен вебхук.

##### webhooks.[name].validators

Список валидаторов, которые будут применены к вебхуку.

##### webhooks.[name].when

Условия, при которых будет выполняться вебхук.
Доступно только условие соответствия значения из тела запроса вебхука определенному значению.
Передается в виде key-value. Пример:

```yaml
...
when:
  "json.branch": "dev"
...
```

Выполнится если в теле запроса вебхука будет поле `branch` со значением `dev`.

Отличие `when` от `validators` в том, что в случае несоответствия условиям из `when` вебхук не создаст задачу, но вернет 200.
В случае несоответствия условиям из `validators` вебхук не создаст задачу и вернет 401.

##### webhooks.[name].mapenv

Настройки маппинга данных из запроса в переменные окружения, которые будут переданы в задачу.

Для передачи значения из тела запроса (json) нужно указать путь к значению через точку, начиная с `json`.

Пример конфига:

```yaml
...
mapenv:
  "json.some.path": "SOME_VALUE"
...
```

Пример запроса:

```json
{
  "some": {
    "path": "value"
  }
}
```

Получаем переменную окружения `SOME_VALUE` со значением `value`.

##### webhooks.[name].tasks

Задачи, которые будут помещаться в очередь при выполнении вебхука.

##### validators

Конфигурация валидаторов, указанных в вебхуках

##### validators.[name]

Название валидатора, передается в вебхуке

##### validators.[name].driver

Драйвер валидатора. Доступные драйверы:
- **header**

##### validators.[name].options

Опции валидатора. Для каждого драйвера свои опции.

Для **header**:
- **header** - название заголовка
- **value** - значение заголовка

##### runner

Конфигурация для исполнителя задач.

##### runner.concurrency

Ограничение максимального количества одновременно выполняемых задач.
По умолчанию `1`. Если передать значение <= 0 - не будет ограничений.

##### runner.dir

Если указан, то исполнитель будет использовать директорию для обработки очереди.

- **dir.path** - путь к директории

##### tasks

Список задач, которые могут быть выполнены.

##### tasks.[name]

Имя задачи. Должно быть уникальным.

##### tasks.[name].command

Команда, которая будет исполнена при выполнении задачи.

##### tasks.[name].dir

Если указан, то исполнитель будет использовать директорию для выполнения задачи.

##### tasks.[name].notifications

Тексты уведомлений, которые будут отправлены в чат при выполнении задачи.

##### tasks.[name].notifications.success

Текст уведомления, которое будет отправлено в чат при успешном выполнении задачи.

##### tasks.[name].notifications.failure

Текст уведомления, которое будет отправлено в чат при неуспешном выполнении задачи.

##### notifiers

Список каналов уведомлений о выполнении задач.

Доступные каналы:

**telegram** - данные бота для отправки уведомлений в Telegram:

- **telegram.botToken** - токен бота
- **telegram.chatId** - идентификатор чата
- **telegram.params** - дополнительные параметры, которые нужно добавить в тело
  запроса [sendMessage](https://core.telegram.org/bots/api#sendmessage)
